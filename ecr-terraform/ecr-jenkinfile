pipeline {
    agent any
    
    stages {
        stage('Setup AWS Credentials') {
            steps {
                script {
                    // Configure AWS CLI
                    sh '''
                        # Configure AWS region
                        aws configure set region ${AWS_REGION}
                        aws configure set output json
                        
                        # For Learner Lab, if running on EC2 with LabInstanceProfile
                        # credentials are automatically available via metadata service
                        
                        # Test if credentials work
                        if ! aws sts get-caller-identity; then
                            echo "ERROR: AWS credentials not configured!"
                            echo "Please do one of:"
                            echo "1. Attach LabInstanceProfile to Jenkins EC2"
                            echo "2. Configure AWS credentials in Jenkins"
                            echo "3. Use withCredentials binding"
                            exit 1
                        fi
                    '''
                }
            }
        }
        

    environment {
        AWS_REGION = 'us-east-1'
        TERRAFORM_DIR = 'ecr-terraform'
        ECR_REPO_NAME = 'microservices-ecr'
        // Learner Lab specific
        LAB_ROLE_ARN = 'arn:aws:iam::${AWS_ACCOUNT_ID}:role/LabRole'
    }

    stages {
        stage('Setup AWS Credentials') {
            steps {
                script {
                    echo "üöÄ Setting up Learner Lab AWS credentials..."
                    
                    // Method 1: If Jenkins has LabInstanceProfile attached
                    sh '''
                        echo "=== AWS Credentials Setup ==="
                        
                        # Check if we're on EC2 with instance profile
                        if curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null; then
                            echo "Using EC2 instance profile credentials"
                            INSTANCE_PROFILE=$(curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/)
                            echo "Instance profile: $INSTANCE_PROFILE"
                        else
                            echo "No instance profile detected"
                        fi
                        
                        # Get AWS account ID
                        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text 2>/dev/null || echo "NOT_AVAILABLE")
                        echo "AWS Account ID: $AWS_ACCOUNT_ID"
                        
                        # Configure AWS CLI
                        aws configure set region ${AWS_REGION}
                        aws configure set output json
                        
                        # Test AWS credentials
                        aws sts get-caller-identity && echo "‚úÖ AWS credentials working" || echo "‚ùå AWS credentials failed"
                    '''
                }
            }
        }

        stage('Checkout Git Repository') {
            steps {
                echo "üîÑ Checking out Git repository..."
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'master']],
                    extensions: [
                        [$class: 'CleanBeforeCheckout'],
                        [$class: 'CloneOption', depth: 1, noTags: false, shallow: true]
                    ],
                    userRemoteConfigs: [[
                        url: 'https://github.com/aymenmahrez-19/Microservices-E-Commerce-eks-project.git'
                    ]]
                ])
            }
        }

        stage('Terraform Version') {
            steps {
                sh '''
                    echo "=== Terraform Version ==="
                    terraform --version
                    echo "=== AWS CLI Version ==="
                    aws --version
                '''
            }
        }

        stage('Fix Terraform Files') {
            steps {
                dir(env.TERRAFORM_DIR) {
                    sh '''
                        echo "üîß Fixing Terraform file extensions..."
                        
                        # Rename .tr files to .tf if they exist
                        if ls *.tr 1> /dev/null 2>&1; then
                            echo "Renaming .tr files to .tf..."
                            for file in *.tr; do
                                new_name="${file%.tr}.tf"
                                echo "Renaming $file to $new_name"
                                mv "$file" "$new_name"
                            done
                        fi
                        
                        # Check what files exist
                        echo "=== Current directory contents ==="
                        ls -la
                        
                        echo "=== Terraform files ==="
                        ls -la *.tf 2>/dev/null || echo "No .tf files found"
                    '''
                }
            }
        }

        stage('Terraform Init - Fixed Credentials') {
            steps {
                dir(env.TERRAFORM_DIR) {
                    script {
                        echo "‚öôÔ∏è Initializing Terraform with Learner Lab credentials..."
                        
                        // Option 1: Use AWS_PROFILE environment variable
                        withEnv(['AWS_PROFILE=default']) {
                            sh '''
                                # Configure AWS credentials explicitly
                                export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
                                export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
                                export AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
                                
                                echo "Testing AWS connectivity..."
                                aws sts get-caller-identity || {
                                    echo "AWS credentials not working. Trying alternative methods..."
                                    
                                    # Try using the LabRole if we're on EC2
                                    if [ -f "/var/run/secrets/eks.amazonaws.com/serviceaccount/token" ]; then
                                        echo "Running on EKS, using service account token"
                                    else
                                        echo "Attempting to use instance metadata..."
                                        # Try to get credentials from instance metadata
                                        if curl -s http://169.254.169.254/latest/meta-data/ 2>/dev/null; then
                                            echo "EC2 instance detected, credentials should be available via metadata"
                                        fi
                                    }
                                }
                                
                                # Initialize Terraform with explicit backend config
                                echo "Initializing Terraform..."
                                
                                # Check if backend config exists
                                if [ -f "backend.tf" ] || [ -f "backend.tr" ]; then
                                    echo "Backend configuration found"
                                    terraform init -input=false -reconfigure
                                else
                                    echo "No backend config, using local backend"
                                    # Create a minimal terraform block if none exists
                                    if [ ! -f "terraform.tf" ] && [ ! -f "terraform.tr" ]; then
                                        cat > terraform.tf << EOF
terraform {
  required_version = ">= 1.0"
  backend "local" {
    path = "terraform.tfstate"
  }
}
EOF
                                    fi
                                    terraform init -input=false -reconfigure
                                fi
                            '''
                        }
                    }
                }
            }
        }

        stage('Manual AWS Credentials Setup') {
            steps {
                script {
                    echo "üîê Manual AWS Credentials Setup Required"
                    echo "Since this is a Learner Lab, you need to configure AWS credentials:"
                    echo ""
                    echo "OPTION 1: If Jenkins is running on EC2 with LabInstanceProfile:"
                    echo "   - Make sure Jenkins EC2 has LabInstanceProfile attached"
                    echo "   - AWS credentials will be available automatically"
                    echo ""
                    echo "OPTION 2: Configure credentials manually:"
                    echo "   1. Go to Jenkins ‚Üí Manage Jenkins ‚Üí Credentials"
                    echo "   2. Add AWS credentials with ID 'aws-credentials'"
                    echo "   3. Use AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY from Learner Lab"
                    echo ""
                    echo "OPTION 3: Use withCredentials binding (uncomment below)"
                    
                    // Uncomment and configure this if you have credentials in Jenkins
                    /*
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: 'aws-credentials',
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                        dir(env.TERRAFORM_DIR) {
                            sh '''
                                export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
                                export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
                                terraform init -input=false -reconfigure
                            '''
                        }
                    }
                    */
                    
                    // For now, let's create a simple test
                    sh '''
                        echo "=== Testing minimal AWS setup ==="
                        
                        # Create a minimal AWS configuration
                        mkdir -p ~/.aws
                        cat > ~/.aws/config << EOF
[default]
region = ${AWS_REGION}
output = json
EOF
                        
                        # Test with public AWS service (no credentials needed)
                        aws ec2 describe-regions --region us-east-1 --query "Regions[].RegionName" --output text || echo "This requires credentials"
                    '''
                }
            }
        }

        stage('Create Minimal Terraform Configuration') {
            steps {
                dir(env.TERRAFORM_DIR) {
                    sh '''
                        echo "üìù Creating minimal Terraform configuration for testing..."
                        
                        # Create provider.tf if it doesn't exist
                        if [ ! -f "provider.tf" ] && [ ! -f "provider.tr" ]; then
                            cat > provider.tf << 'EOF'
provider "aws" {
  region = "us-east-1"
  
  # In Learner Lab, assume LabRole is available
  # assume_role {
  #   role_arn = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:role/LabRole"
  # }
  
  # Skip credential validation for testing
  skip_credentials_validation = true
  skip_metadata_api_check     = true
  skip_requesting_account_id  = true
}

data "aws_caller_identity" "current" {}

data "aws_region" "current" {}
EOF
                        fi
                        
                        # Create main.tf if it doesn't exist
                        if [ ! -f "main.tf" ] && [ ! -f "main.tr" ] && [ ! -f "ecr-repo-main.tf" ] && [ ! -f "ecr-repo-main.tr" ]; then
                            cat > main.tf << 'EOF'
# Simple ECR repository for Learner Lab testing
resource "aws_ecr_repository" "test_repo" {
  name = "learner-lab-test-${data.aws_caller_identity.current.account_id}"
  
  image_scanning_configuration {
    scan_on_push = false  # Disable to save costs
  }
  
  image_tag_mutability = "MUTABLE"
  
  tags = {
    Environment = "LearnerLab-Test"
    CreatedBy   = "Jenkins"
    AutoDelete  = "true"
  }
}

output "repository_url" {
  value = aws_ecr_repository.test_repo.repository_url
  description = "URL of the created ECR repository"
}

output "repository_name" {
  value = aws_ecr_repository.test_repo.name
  description = "Name of the created ECR repository"
}
EOF
                        fi
                    '''
                }
            }
        }

        stage('Test Terraform Plan') {
            steps {
                dir(env.TERRAFORM_DIR) {
                    sh '''
                        echo "üìä Testing Terraform plan..."
                        
                        # First, let's see what Terraform thinks
                        echo "=== Terraform Validate ==="
                        terraform validate || echo "Validate failed (might need credentials)"
                        
                        echo "=== Terraform Providers ==="
                        terraform providers
                        
                        # Try a plan without actual AWS calls
                        echo "=== Dry-run Plan ==="
                        terraform plan -target=null_resource.dummy 2>&1 || \
                        echo "Plan requires AWS credentials"
                        
                        # Create a dummy resource for testing
                        if [ ! -f "dummy.tf" ]; then
                            cat > dummy.tf << 'EOF'
resource "null_resource" "dummy" {
  triggers = {
    always_run = timestamp()
  }
  
  provisioner "local-exec" {
    command = "echo 'Terraform is configured correctly on ${timestamp()}'"
  }
}
EOF
                            terraform init
                            terraform plan -target=null_resource.dummy
                            terraform apply -target=null_resource.dummy -auto-approve
                        fi
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "üîö Pipeline execution completed"
            
            // Cleanup
            sh '''
                echo "=== Cleaning up ==="
                find . -name "*.tfstate*" -type f -delete 2>/dev/null || true
                find . -name "*.backup" -type f -delete 2>/dev/null || true
                find . -name ".terraform" -type d -exec rm -rf {} + 2>/dev/null || true
            '''
            
            // Archive logs
            archiveArtifacts artifacts: '**/*.log', allowEmptyArchive: true
        }
        
        success {
            echo "‚úÖ Pipeline succeeded!"
            echo ""
            echo "NEXT STEPS for Learner Lab:"
            echo "1. Configure AWS credentials in Jenkins"
            echo "2. Attach LabInstanceProfile to Jenkins EC2"
            echo "3. Update Terraform files to use .tf extension"
            echo "4. Test with: terraform init && terraform plan"
        }
        
        failure {
            echo "‚ùå Pipeline failed"
            echo ""
            echo "TROUBLESHOOTING Learner Lab:"
            echo "1. Check if AWS credentials are configured"
            echo "2. Verify Jenkins has AWS permissions"
            echo "3. Ensure Terraform files have .tf extension"
            echo "4. Try running AWS CLI manually: aws sts get-caller-identity"
        }
    }

    options {
        timeout(time: 1, unit: 'HOURS')
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
}