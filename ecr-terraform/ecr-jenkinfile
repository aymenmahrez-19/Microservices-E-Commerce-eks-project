pipeline {
    agent any 

    environment {
        AWS_REGION = 'us-east-1'
        TERRAFORM_DIR = 'ecr-terraform'
        GIT_EMAIL = 'aymen.bendjaballah@univ-constantine2.dz'
        GIT_USER_NAME = 'aymenmahrez-19'
        GIT_REPO_NAME = 'Microservices-E-Commerce-eks-project'
    }

    parameters {
        choice(
            name: 'ACTION',
            choices: ['plan', 'apply', 'destroy'],
            description: 'Select Terraform action (plan=preview, apply=create, destroy=delete)'
        )
        
        string(
            name: 'ECR_REPO_PREFIX',
            defaultValue: 'aymen',
            description: 'Prefix for all ECR repositories'
        )
        
        choice(
            name: 'AWS_REGION',
            choices: ['us-east-1', 'us-west-2'],
            description: 'AWS Region'
        )
        
        booleanParam(
            name: 'AUTO_APPROVE',
            defaultValue: false,
            description: 'Auto-approve apply/destroy'
        )
    }

    stages {
        stage('Check Environment') {
            steps {
                script {
                    echo "Action: ${params.ACTION}"
                    echo "ECR Repo Prefix: ${params.ECR_REPO_PREFIX}"
                    echo "AWS Region: ${params.AWS_REGION}"
                    sh '''
                        aws configure set region ${AWS_REGION}
                        aws configure set output json
                        echo "AWS identity:"
                        aws sts get-caller-identity
                        terraform --version
                    '''
                }
            }
        }

        stage('Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/master']],
                    extensions: [[$class: 'CleanBeforeCheckout']],
                    userRemoteConfigs: [[url: "https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git"]]
                ])
                sh "ls -la ${TERRAFORM_DIR}"
            }
        }

        stage('Terraform Init') {
            steps {
                dir(env.TERRAFORM_DIR) {
                    sh '''
                        echo "Initializing Terraform..."
                        terraform init -input=false -reconfigure
                    '''
                }
            }
        }

        stage('Terraform Plan') {
            when {
                expression { params.ACTION == 'plan' || params.ACTION == 'apply' }
            }
            steps {
                dir(env.TERRAFORM_DIR) {
                    sh """
                        echo "Running Terraform plan..."
                        terraform plan -out=tfplan -var="repo_prefix=${params.ECR_REPO_PREFIX}" -var="region=${params.AWS_REGION}"
                        terraform show -no-color tfplan
                    """
                    archiveArtifacts artifacts: '**/tfplan', fingerprint: true
                }
            }
        }

        stage('Terraform Apply') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir(env.TERRAFORM_DIR) {
                    sh """
                        echo "Applying Terraform..."
                        terraform apply ${params.AUTO_APPROVE ? '-auto-approve tfplan' : 'tfplan'}
                        terraform output
                    """
                }
            }
        }

        stage('Terraform Destroy') {
            when {
                expression { params.ACTION == 'destroy' }
            }
            steps {
                dir(env.TERRAFORM_DIR) {
                    sh """
                        echo "Destroying Terraform resources..."
                        terraform destroy ${params.AUTO_APPROVE ? '-auto-approve' : ''} -var="repo_prefix=${params.ECR_REPO_PREFIX}" -var="region=${params.AWS_REGION}"
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
            echo "Pipeline finished"
        }
        success {
            echo "✅ Pipeline completed successfully"
        }
        failure {
            echo "❌ Pipeline failed. Check Terraform configuration and AWS credentials"
        }
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
}
