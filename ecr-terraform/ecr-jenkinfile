pipeline {
    agent any 

    environment {
        AWS_REGION = 'us-east-1'
        TERRAFORM_DIR = 'ecr-terraform'
        ECR_REPO_NAME = 'microservices-ecr-repo'
        MAX_REPOSITORIES = '5'  // Limit to save costs
        IMAGE_RETENTION_DAYS = '3'  // Keep images only for 3 days
    }

    stages {
        stage('Check Learner Lab Constraints') {
            steps {
                script {
                    echo "=== LEARNER LAB ENVIRONMENT ==="
                    echo "Region: ${AWS_REGION}"
                    echo "Max EC2 Instances: 9"
                    echo "Max vCPU: 32"
                    echo "Instance types: nano, micro, small, medium, large only"
                    
                    // Check current ECR usage
                    sh '''
                        echo "Checking existing ECR repositories..."
                        aws ecr describe-repositories \
                            --region ${AWS_REGION} \
                            --query "repositories[].repositoryName" \
                            --output text || echo "No repositories or permissions issue"
                    '''
                }
            }
        }

        stage('Cleanup Old Resources') {
            steps {
                script {
                    // Clean up old ECR images before creating new ones
                    sh """
                        # Clean up any dangling Docker images locally
                        docker system prune -f || true
                        
                        # Optional: Clean up very old ECR images if repository exists
                        if aws ecr describe-repositories --repository-names ${ECR_REPO_NAME} --region ${AWS_REGION} 2>/dev/null; then
                            echo "Cleaning up images older than ${IMAGE_RETENTION_DAYS} days..."
                            aws ecr list-images \
                                --repository-name ${ECR_REPO_NAME} \
                                --region ${AWS_REGION} \
                                --query "imageIds[?imagePushedAt<\`\$(date -d '${IMAGE_RETENTION_DAYS} days ago' --iso-8601=seconds)\`].imageTag" \
                                --output text | xargs -r -I {} aws ecr batch-delete-image \
                                    --repository-name ${ECR_REPO_NAME} \
                                    --region ${AWS_REGION} \
                                    --image-ids imageTag={} 2>/dev/null || echo "No old images to delete"
                        fi
                    """
                }
            }
        }

        stage('Terraform Init') {
            steps {
                // In Learner Lab, Jenkins EC2 should have LabInstanceProfile attached
                // If not using instance profile, use withCredentials
                dir(env.TERRAFORM_DIR) {
                    sh '''
                        echo "Initializing Terraform..."
                        echo "Using AWS credentials from instance profile (LabInstanceProfile)"
                        
                        # Verify AWS credentials
                        aws sts get-caller-identity || { echo "AWS credentials not available"; exit 1; }
                        
                        # Initialize Terraform with S3 backend (if configured)
                        terraform init -input=false -reconfigure
                        
                        # Fix file extensions if needed (from .tr to .tf)
                        if [ -f "ecr-repo-main.tr" ]; then
                            echo "Renaming .tr files to .tf..."
                            for file in *.tr; do
                                mv "$file" "${file%.tr}.tf"
                            done
                            terraform init -input=false -reconfigure
                        fi
                    '''
                }
            }
        }

        stage('Terraform Plan - Budget Check') {
            steps {
                dir(env.TERRAFORM_DIR) {
                    sh '''
                        echo "=== TERRAFORM PLAN (Budget Review) ==="
                        
                        # Create plan and save for review
                        terraform plan \
                            -var="region=${AWS_REGION}" \
                            -var="repository_name=${ECR_REPO_NAME}" \
                            -var="max_image_count=10" \
                            -out=tfplan
                        
                        # Show estimated costs (if available)
                        echo "=== RESOURCE ESTIMATES ==="
                        terraform show -json tfplan | jq -r '
                            .planned_values.root_module.resources[] | 
                            select(.type | contains("aws_")) | 
                            "Resource: \(.type) - \(.name)"' || true
                    '''
                    
                    // Archive the plan for review
                    archiveArtifacts artifacts: '**/tfplan', fingerprint: true
                }
            }
        }

        stage('Manual Approval - Budget Check') {
            steps {
                script {
                    // Critical: Manual approval to prevent runaway costs
                    timeout(time: 5, unit: 'MINUTES') {
                        input(
                            message: "‚ö†Ô∏è LEARNER LAB BUDGET WARNING ‚ö†Ô∏è\n\nProceed with ECR creation?\n\nCheck:\n1. Current budget in lab interface\n2. No duplicate resources\n3. Repository name: ${ECR_REPO_NAME}",
                            ok: "Yes, Create ECR",
                            submitterParameter: 'approver'
                        )
                    }
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir(env.TERRAFORM_DIR) {
                    sh '''
                        echo "Applying Terraform plan..."
                        
                        terraform apply \
                            -var="region=${AWS_REGION}" \
                            -var="repository_name=${ECR_REPO_NAME}" \
                            -var="max_image_count=10" \
                            -auto-approve
                        
                        echo "=== ECR REPOSITORY CREATED ==="
                        
                        # Output repository URL
                        terraform output -raw repository_url || echo "No repository_url output defined"
                    '''
                }
            }
        }

        stage('Configure ECR Lifecycle Policy') {
            steps {
                script {
                    // Apply strict lifecycle policy for Learner Lab budget
                    sh """
                        # Create lifecycle policy JSON
                        cat > lifecycle-policy.json << EOF
                        {
                            "rules": [
                                {
                                    "rulePriority": 1,
                                    "description": "Keep only last 10 images",
                                    "selection": {
                                        "tagStatus": "any",
                                        "countType": "imageCountMoreThan",
                                        "countNumber": 10
                                    },
                                    "action": {
                                        "type": "expire"
                                    }
                                },
                                {
                                    "rulePriority": 2,
                                    "description": "Expire untagged images after 1 day",
                                    "selection": {
                                        "tagStatus": "untagged",
                                        "countType": "sinceImagePushed",
                                        "countUnit": "days",
                                        "countNumber": 1
                                    },
                                    "action": {
                                        "type": "expire"
                                    }
                                }
                            ]
                        }
                        EOF
                        
                        # Apply lifecycle policy
                        aws ecr put-lifecycle-policy \
                            --repository-name ${ECR_REPO_NAME} \
                            --region ${AWS_REGION} \
                            --lifecycle-policy-text file://lifecycle-policy.json
                        
                        echo "Lifecycle policy applied to ${ECR_REPO_NAME}"
                    """
                }
            }
        }

        stage('Test ECR Access') {
            steps {
                script {
                    sh """
                        # Test ECR login
                        aws ecr get-login-password --region ${AWS_REGION} | \
                        docker login --username AWS --password-stdin \
                        ${aws sts get-caller-identity --query Account --output text}.dkr.ecr.${AWS_REGION}.amazonaws.com
                        
                        echo "‚úÖ ECR login successful"
                        
                        # List repositories
                        echo "=== YOUR ECR REPOSITORIES ==="
                        aws ecr describe-repositories \
                            --region ${AWS_REGION} \
                            --query "repositories[].repositoryName" \
                            --output table
                    """
                }
            }
        }
    }

    post {
        always {
            // Clean up any temporary files
            sh '''
                rm -f tfplan tfplan.json lifecycle-policy.json 2>/dev/null || true
            '''
            
            dir(env.TERRAFORM_DIR) {
                // Save terraform state for debugging
                sh 'terraform show -no-color > terraform-state.txt'
                archiveArtifacts artifacts: 'terraform-state.txt', fingerprint: true
            }
        }
        
        success {
            script {
                def repoUrl = sh(
                    script: "cd ${TERRAFORM_DIR} && terraform output -raw repository_url 2>/dev/null || echo 'Not available'",
                    returnStdout: true
                ).trim()
                
                echo """
                ===========================================
                ‚úÖ ECR REPOSITORY CREATED SUCCESSFULLY
                ===========================================
                Repository: ${ECR_REPO_NAME}
                Region: ${AWS_REGION}
                URL: ${repoUrl}
                
                üí∞ LEARNER LAB BUDGET NOTES:
                1. ECR storage costs approx $0.10 per GB-month
                2. Lifecycle policy keeps only 10 latest images
                3. Untagged images auto-delete after 1 day
                4. Monitor budget in lab interface
                
                üê≥ To push an image:
                docker tag myimage:latest ${repoUrl}:v1.0
                docker push ${repoUrl}:v1.0
                ===========================================
                """
            }
        }
        
        failure {
            echo """
            ‚ùå ECR Creation Failed
            
            LEARNER LAB TROUBLESHOOTING:
            1. Check if you've exceeded repository limit
            2. Verify AWS credentials (use LabInstanceProfile)
            3. Check terraform state: terraform show
            4. Ensure region is us-east-1 or us-west-2
            """
        }
        
        cleanup {
            // Final cleanup
            cleanWs()
        }
    }

    options {
        timeout(time: 15, unit: 'MINUTES')
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }
    
    parameters {
        string(
            name: 'ECR_REPO_NAME',
            defaultValue: 'microservices-ecr-repo',
            description: 'ECR repository name (lowercase, hyphens only)'
        )
        
        choice(
            name: 'AWS_REGION',
            choices: ['us-east-1', 'us-west-2'],
            description: 'Learner Lab allowed regions'
        )
        
        booleanParam(
            name: 'APPLY_LIFECYCLE_POLICY',
            defaultValue: true,
            description: 'Apply strict lifecycle policy to save costs'
        )
    }
}