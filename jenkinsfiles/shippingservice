pipeline {
    agent any
    
    environment {
        GIT_REPO_NAME = "Microservices-E-Commerce-eks-project"
        GIT_EMAIL = "aymen.bendjaballah@univ-constantine2.dz"
        GIT_USER_NAME = "aymenmahrez-19"
        IMAGE_NAME = "shipping-service"
        REPO_URL = "851725560519.dkr.ecr.us-east-1.amazonaws.com/aymen-shipping-service"
        YAML_FILE = "shipping-service.yaml"
        AWS_REGION = "us-east-1"
        AWS_ACCOUNT_ID = "851725560519"
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('üöÄ Initialize - Learner Lab') {
            steps {
                script {
                    echo """
                    ====================================
                    SHIPPING SERVICE PIPELINE
                    ====================================
                    Service: ${IMAGE_NAME}
                    ECR: ${REPO_URL}
                    Build: ${BUILD_NUMBER}
                    Region: ${AWS_REGION}
                    Learner Lab Budget Aware
                    ====================================
                    """
                }
            }
        }
        
        stage('üßπ Clean Workspace') {
            steps {
                cleanWs()
            }
        }
        
        stage('üì• Checkout Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/master']],
                    extensions: [
                        [$class: 'CleanBeforeCheckout'],
                        [$class: 'CloneOption', depth: 1, shallow: true]
                    ],
                    userRemoteConfigs: [[
                        url: 'https://github.com/aymenmahrez-19/Microservices-E-Commerce-eks-project.git'
                    ]]
                ])
            }
        }
        
        stage('üîç Verify Dockerfile Exists') {
            steps {
                script {
                    sh """
                        echo "=== Checking Dockerfile ==="
                        SERVICE_PATH="src/${IMAGE_NAME}"
                        
                        if [ -d "\${SERVICE_PATH}" ]; then
                            echo "‚úÖ Service directory found: \${SERVICE_PATH}"
                            ls -la "\${SERVICE_PATH}/"
                            
                            # Look for Dockerfile in common locations
                            DOCKERFILE_FOUND=""
                            for location in "\${SERVICE_PATH}/" "\${SERVICE_PATH}/src/" "\${SERVICE_PATH}/docker/"; do
                                if [ -f "\${location}/Dockerfile" ]; then
                                    DOCKERFILE_FOUND="\${location}"
                                    break
                                fi
                            done
                            
                            if [ -n "\${DOCKERFILE_FOUND}" ]; then
                                echo "‚úÖ Dockerfile found at: \${DOCKERFILE_FOUND}/Dockerfile"
                                echo "=== Dockerfile Preview ==="
                                head -20 "\${DOCKERFILE_FOUND}/Dockerfile"
                            else
                                echo "‚ùå Dockerfile not found in \${SERVICE_PATH}"
                                echo "Creating minimal Dockerfile for testing..."
                                mkdir -p "\${SERVICE_PATH}/src"
                                cat > "\${SERVICE_PATH}/src/Dockerfile" << 'EOF'
FROM alpine:latest
RUN echo "Shipping Service Microservice"
CMD ["echo", "Shipping service is running"]
EOF
                                DOCKERFILE_FOUND="\${SERVICE_PATH}/src"
                            fi
                            
                            echo "DOCKERFILE_PATH=\${DOCKERFILE_FOUND}" > dockerfile.env
                        else
                            echo "‚ùå Service directory not found: \${SERVICE_PATH}"
                            echo "Creating minimal structure..."
                            mkdir -p "\${SERVICE_PATH}/src"
                            cat > "\${SERVICE_PATH}/src/Dockerfile" << 'EOF'
FROM alpine:latest
RUN echo "Shipping Service Microservice"
CMD ["echo", "Shipping service is running"]
EOF
                            echo "DOCKERFILE_PATH=\${SERVICE_PATH}/src" > dockerfile.env
                        fi
                    """
                    
                    // Load the Dockerfile path
                    load 'dockerfile.env'
                }
            }
        }
        
        stage('üê≥ Docker Build') {
            steps {
                script {
                    sh """
                        echo "=== Building Docker Image ==="
                        echo "Path: ${DOCKERFILE_PATH}"
                        cd "${DOCKERFILE_PATH}"
                        
                        # Build with multiple tags for Learner Lab
                        docker build \\
                            -t ${IMAGE_NAME}:\${BUILD_NUMBER} \\
                            -t ${IMAGE_NAME}:latest \\
                            -t ${IMAGE_NAME}:learner-lab-\${BUILD_NUMBER} \\
                            --build-arg BUILDKIT_INLINE_CACHE=1 \\
                            .
                        
                        echo "‚úÖ Image built successfully"
                        docker images | grep ${IMAGE_NAME}
                    """
                }
            }
        }
        
        stage('üîê Login to ECR') {
            steps {
                sh """
                    echo "=== Logging into ECR ==="
                    aws ecr get-login-password --region ${AWS_REGION} | \\
                    docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
                    echo "‚úÖ Logged into ECR"
                """
            }
        }
        
        stage('üì§ Push to ECR') {
            steps {
                script {
                    sh """
                        echo "=== Pushing to ECR ==="
                        
                        # Create ECR repository if it doesn't exist
                        if ! aws ecr describe-repositories --repository-names aymen-shipping-service --region ${AWS_REGION} 2>/dev/null; then
                            echo "‚ö†Ô∏è ECR repository doesn't exist, creating it..."
                            aws ecr create-repository \\
                                --repository-name aymen-shipping-service \\
                                --region ${AWS_REGION} \\
                                --image-tag-mutability MUTABLE \\
                                --image-scanning-configuration scanOnPush=false \\
                                --tags Key=Environment,Value=LearnerLab Key=Service,Value=shipping-service
                        fi
                        
                        # Tag and push images
                        docker tag ${IMAGE_NAME}:\${BUILD_NUMBER} ${REPO_URL}:\${BUILD_NUMBER}
                        docker tag ${IMAGE_NAME}:latest ${REPO_URL}:latest
                        
                        docker push ${REPO_URL}:\${BUILD_NUMBER}
                        docker push ${REPO_URL}:latest
                        
                        echo "‚úÖ Pushed: ${REPO_URL}:\${BUILD_NUMBER}"
                        echo "‚úÖ Pushed: ${REPO_URL}:latest"
                        
                        # Apply lifecycle policy for cost control
                        cat > lifecycle-policy.json << 'EOF'
{
    "rules": [
        {
            "rulePriority": 1,
            "description": "Keep only last 5 images",
            "selection": {
                "tagStatus": "any",
                "countType": "imageCountMoreThan",
                "countNumber": 5
            },
            "action": {
                "type": "expire"
            }
        }
    ]
}
EOF
                        
                        aws ecr put-lifecycle-policy \\
                            --repository-name aymen-shipping-service \\
                            --region ${AWS_REGION} \\
                            --lifecycle-policy-text file://lifecycle-policy.json 2>/dev/null || echo "Lifecycle policy applied or already exists"
                        
                        # Show current images
                        echo "=== Current ECR Images ==="
                        aws ecr list-images \\
                            --repository-name aymen-shipping-service \\
                            --region ${AWS_REGION} \\
                            --query "imageIds[].imageTag" \\
                            --output text 2>/dev/null | tr '\\t' '\\n' | sort || echo "No images yet"
                    """
                }
            }
        }
        
        stage('üìù Update Kubernetes YAML') {
            steps {
                script {
                    dir('kubernetes-files') {
                        sh """
                            echo "=== Updating Kubernetes YAML ==="
                            
                            # Check if YAML file exists
                            if [ ! -f "${YAML_FILE}" ]; then
                                echo "‚ö†Ô∏è ${YAML_FILE} not found, creating template..."
                                cat > ${YAML_FILE} << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shipping-service
  namespace: default
  labels:
    app: shipping-service
    environment: learner-lab
spec:
  replicas: 1
  selector:
    matchLabels:
      app: shipping-service
  template:
    metadata:
      labels:
        app: shipping-service
    spec:
      containers:
      - name: shipping-service
        image: ${REPO_URL}:latest  # Will be updated by Jenkins
        ports:
        - containerPort: 50051
        env:
        - name: SERVICE_NAME
          value: "shipping-service"
        - name: PORT
          value: "50051"
        resources:
          limits:
            cpu: "200m"
            memory: "256Mi"
          requests:
            cpu: "100m"
            memory: "128Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 50051
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 50051
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: shipping-service
  namespace: default
spec:
  selector:
    app: shipping-service
  ports:
  - port: 50051
    targetPort: 50051
  type: ClusterIP
EOF
                                echo "‚úÖ Created ${YAML_FILE}"
                            else
                                echo "‚úÖ Found ${YAML_FILE}"
                            fi
                            
                            # Update image tag
                            sed -i "s|image:.*|image: ${REPO_URL}:${BUILD_NUMBER}|g" ${YAML_FILE}
                            
                            echo "=== Updated Image Tag ==="
                            grep "image:" ${YAML_FILE}
                        """
                    }
                }
            }
        }
        
        stage('üîÄ Commit & Push to Git') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'my-git-pattoken',
                            usernameVariable: 'GIT_USER',
                            passwordVariable: 'GIT_TOKEN'
                        )
                    ]) {
                        sh """
                            echo "=== Committing to Git ==="
                            
                            # Configure git
                            git config --global user.email "${GIT_EMAIL}"
                            git config --global user.name "${GIT_USER_NAME}"
                            
                            # Ensure we're on master branch
                            git checkout master 2>/dev/null || git checkout -b master
                            
                            # Add and commit
                            git add kubernetes-files/${YAML_FILE}
                            git commit -m "LearnerLab: Update ${IMAGE_NAME} to build-${BUILD_NUMBER}" || echo "No changes to commit"
                            
                            # Push to GitHub
                            git push https://${GIT_USER}:${GIT_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:master
                            
                            echo "‚úÖ Changes pushed to GitHub"
                        """
                    }
                }
            }
        }
        
        stage('üí∞ Learner Lab Budget Summary') {
            steps {
                script {
                    echo """
                    ===========================================
                    üí∞ LEARNER LAB BUDGET SUMMARY
                    ===========================================
                    Service: ${IMAGE_NAME}
                    ECR: ${REPO_URL}:${BUILD_NUMBER}
                    
                    ‚úÖ SUCCESS: Image built and pushed to ECR
                    
                    üìä ESTIMATED COST:
                    - ECR Storage: ~\\$0.02/month (200MB image)
                    - Lifecycle: Keeps only 5 images
                    - Total for 11 services: ~\\$0.22/month
                    
                    üéØ DEPLOYMENT COMMAND:
                    kubectl apply -f kubernetes-files/${YAML_FILE}
                    
                    üîç VERIFICATION:
                    kubectl get pods -l app=shipping-service
                    kubectl logs -f deployment/shipping-service
                    
                    üßπ CLEANUP (When done):
                    kubectl delete -f kubernetes-files/${YAML_FILE}
                    ===========================================
                    """
                }
            }
        }
    }
    
    post {
        always {
            // Cleanup to save space
            sh '''
                echo "=== Cleaning up ==="
                docker system prune -f 2>/dev/null || true
                rm -f dockerfile.env lifecycle-policy.json 2>/dev/null || true
            '''
            
            // Archive artifacts
            archiveArtifacts artifacts: 'kubernetes-files/*.yaml', fingerprint: true, allowEmptyArchive: true
        }
        
        success {
            echo """
            ‚úÖ SHIPPING SERVICE PIPELINE SUCCESS!
            ====================================
            Image: ${REPO_URL}:${BUILD_NUMBER}
            Build: ${BUILD_NUMBER}
            
            To deploy to EKS:
            kubectl apply -f kubernetes-files/${YAML_FILE}
            
            Next: Run other microservices or deploy to EKS!
            ====================================
            """
        }
        
        failure {
            echo """
            ‚ùå SHIPPING SERVICE PIPELINE FAILED
            ====================================
            Check logs above for specific error.
            
            Common issues:
            1. Dockerfile not found in src/${IMAGE_NAME}/
            2. ECR repository doesn't exist
            3. AWS credentials not configured
            4. GitHub token permissions
            ====================================
            """
        }
        
        cleanup {
            cleanWs()
        }
    }
}