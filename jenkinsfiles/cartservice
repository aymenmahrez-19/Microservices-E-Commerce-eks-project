pipeline {
    agent any
    
    environment {
        AWS_REGION = 'us-east-1'
        AWS_ACCOUNT_ID = '851725560519'
        SERVICE_NAME = 'cartservice'                // ÿßÿ≥ŸÖ ÿßŸÑÿÆÿØŸÖÿ© ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
        ECR_REPO_NAME = 'aymen-cart-service'        // ‚úÖ ÿßÿ≥ŸÖ ŸÖÿ≥ÿ™ŸàÿØÿπ ECR ÿßŸÑŸÖŸàÿ¨ŸàÿØ
        DOCKERFILE_PATH = 'src/cartservice'         // ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑÿµÿ≠Ÿäÿ≠
        ECR_REPO_URL = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"
        GIT_EMAIL = 'aymen.bendjaballah@univ-constantine2.dz'
        GIT_USER_NAME = 'aymenmahrez-19'
    }
    
    stages {
        stage('Check Environment') {
            steps {
                script {
                    echo """
                    üöÄ Cart Service Pipeline - Learner Lab
                    ==================================
                    Service: ${SERVICE_NAME}
                    ECR Repository: ${ECR_REPO_NAME}
                    ECR URL: ${ECR_REPO_URL}
                    Dockerfile Path: ${DOCKERFILE_PATH}
                    Build: ${BUILD_NUMBER}
                    ==================================
                    """
                    
                    // Verify Dockerfile exists
                    sh """
                        echo "=== Checking Dockerfile ==="
                        
                        # Check multiple possible locations
                        if [ -f "${DOCKERFILE_PATH}/Dockerfile" ]; then
                            echo "‚úÖ Dockerfile found at ${DOCKERFILE_PATH}/Dockerfile"
                            echo "=== Dockerfile Contents ==="
                            head -20 "${DOCKERFILE_PATH}/Dockerfile"
                        elif [ -f "${DOCKERFILE_PATH}/src/Dockerfile" ]; then
                            echo "‚úÖ Dockerfile found at ${DOCKERFILE_PATH}/src/Dockerfile"
                            echo "=== Dockerfile Contents ==="
                            head -20 "${DOCKERFILE_PATH}/src/Dockerfile"
                            export DOCKERFILE_PATH="${DOCKERFILE_PATH}/src"
                        else
                            echo "‚ùå Dockerfile NOT FOUND at ${DOCKERFILE_PATH}/"
                            echo "Creating minimal Dockerfile..."
                            mkdir -p "${DOCKERFILE_PATH}"
                            cat > "${DOCKERFILE_PATH}/Dockerfile" << 'EOF'
FROM alpine:latest
RUN echo "Cart Service Microservice"
CMD ["echo", "Cart service is running"]
EOF
                            echo "‚úÖ Created minimal Dockerfile"
                        fi
                    """
                }
            }
        }
        
        stage('Setup AWS for Learner Lab') {
            steps {
                script {
                    sh """
                        # Configure AWS for Learner Lab
                        aws configure set region ${AWS_REGION}
                        aws configure set output json
                        
                        # Test credentials
                        aws sts get-caller-identity && echo "‚úÖ AWS credentials working" || echo "‚ö†Ô∏è AWS credentials issue"
                        
                        # Verify ECR repository exists
                        echo "=== Checking ECR Repository ==="
                        if aws ecr describe-repositories --repository-names ${ECR_REPO_NAME} --region ${AWS_REGION} 2>/dev/null; then
                            echo "‚úÖ ECR repository exists: ${ECR_REPO_NAME}"
                        else
                            echo "‚ùå ECR repository NOT FOUND: ${ECR_REPO_NAME}"
                            echo "Available repositories:"
                            aws ecr describe-repositories --region ${AWS_REGION} --query "repositories[].repositoryName" --output text || true
                            echo "You need to create: ${ECR_REPO_NAME}"
                        fi
                    """
                }
            }
        }
        
        stage('Login to ECR') {
            steps {
                script {
                    sh """
                        # Login to ECR
                        echo "=== Logging into ECR ==="
                        aws ecr get-login-password --region ${AWS_REGION} | \
                        docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
                        
                        echo "‚úÖ Logged into ECR"
                    """
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                dir(env.DOCKERFILE_PATH) {
                    sh """
                        echo "=== Building Docker Image ==="
                        echo "Path: \$(pwd)"
                        echo "Files:"
                        ls -la
                        
                        # Clean previous builds
                        docker system prune -f 2>/dev/null || true
                        
                        # Build with cache optimization for Learner Lab
                        docker build \
                            -t ${SERVICE_NAME}:\${BUILD_NUMBER} \
                            -t ${SERVICE_NAME}:latest \
                            --build-arg BUILDKIT_INLINE_CACHE=1 \
                            .
                        
                        echo "‚úÖ Image built: ${SERVICE_NAME}:\${BUILD_NUMBER}"
                        docker images | grep ${SERVICE_NAME}
                    """
                }
            }
        }
        
        stage('Push to ECR') {
            steps {
                script {
                    sh """
                        # Tag and push to EXISTING ECR repository
                        echo "=== Pushing to ECR Repository ==="
                        echo "Repository: ${ECR_REPO_NAME}"
                        echo "URL: ${ECR_REPO_URL}"
                        
                        # Tag images
                        docker tag ${SERVICE_NAME}:\${BUILD_NUMBER} ${ECR_REPO_URL}:\${BUILD_NUMBER}
                        docker tag ${SERVICE_NAME}:latest ${ECR_REPO_URL}:latest
                        
                        # Push to ECR
                        echo "Pushing images to ECR..."
                        docker push ${ECR_REPO_URL}:\${BUILD_NUMBER}
                        docker push ${ECR_REPO_URL}:latest
                        
                        echo "‚úÖ Pushed: ${ECR_REPO_URL}:\${BUILD_NUMBER}"
                        echo "‚úÖ Pushed: ${ECR_REPO_URL}:latest"
                        
                        # Apply lifecycle policy for Learner Lab cost control
                        echo "=== Applying lifecycle policy ==="
                        cat > lifecycle-policy.json << 'EOF'
{
    "rules": [
        {
            "rulePriority": 1,
            "description": "Keep only last 5 images",
            "selection": {
                "tagStatus": "any",
                "countType": "imageCountMoreThan",
                "countNumber": 5
            },
            "action": {
                "type": "expire"
            }
        }
    ]
}
EOF
                        
                        aws ecr put-lifecycle-policy \
                            --repository-name ${ECR_REPO_NAME} \
                            --region ${AWS_REGION} \
                            --lifecycle-policy-text file://lifecycle-policy.json 2>/dev/null || echo "Lifecycle policy updated or already exists"
                        
                        # List images in ECR
                        echo "=== ECR Images ==="
                        aws ecr list-images \
                            --repository-name ${ECR_REPO_NAME} \
                            --region ${AWS_REGION} \
                            --query "imageIds[].imageTag" \
                            --output text 2>/dev/null | tr '\\t' '\\n' | sort || echo "No images yet"
                    """
                }
            }
        }
        
        stage('Update Kubernetes YAML') {
            steps {
                script {
                    dir('kubernetes-files') {
                        def yamlFile = 'cartservice.yaml'
                        
                        sh """
                            echo "=== Updating Kubernetes YAML ==="
                            
                            if [ ! -f "${yamlFile}" ]; then
                                echo "‚ö†Ô∏è ${yamlFile} not found, creating one..."
                                
                                cat > "${yamlFile}" << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cartservice
  namespace: default
  labels:
    app: cartservice
    environment: learner-lab
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cartservice
  template:
    metadata:
      labels:
        app: cartservice
    spec:
      containers:
      - name: cartservice
        image: ${ECR_REPO_URL}:latest
        ports:
        - containerPort: 7070
        env:
        - name: PORT
          value: "7070"
        - name: REDIS_ADDR
          value: "redis-cart:6379"
        resources:
          limits:
            cpu: "200m"
            memory: "256Mi"
          requests:
            cpu: "100m"
            memory: "128Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 7070
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 7070
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: cartservice
  namespace: default
spec:
  selector:
    app: cartservice
  ports:
  - port: 7070
    targetPort: 7070
  type: ClusterIP
EOF
                                echo "‚úÖ Created ${yamlFile}"
                            else
                                echo "‚úÖ Found ${yamlFile}"
                            fi
                            
                            # Update image tag
                            sed -i "s|image:.*|image: ${ECR_REPO_URL}:${BUILD_NUMBER}|g" "${yamlFile}"
                            
                            echo "=== Updated Image Tag ==="
                            grep "image:" "${yamlFile}"
                            echo ""
                            echo "=== YAML Preview ==="
                            head -25 "${yamlFile}"
                        """
                    }
                }
            }
        }
        
        stage('Commit and Push to Git') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'my-git-pattoken', variable: 'GIT_TOKEN')]) {
                        sh """
                            # Configure git
                            git config user.email "${GIT_EMAIL}"
                            git config user.name "${GIT_USER_NAME}"
                            
                            # Ensure we're on master branch
                            git checkout master 2>/dev/null || git checkout -b master
                            
                            # Add and commit
                            git add kubernetes-files/cartservice.yaml
                            git commit -m "LearnerLab: Update ${SERVICE_NAME} to build-\${BUILD_NUMBER}" || echo "No changes to commit"
                            
                            # Push to GitHub - FIXED: ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿπ ÿßŸÑÿ™ŸàŸÉŸÜ
                            git push https://${GIT_USER_NAME}:${GIT_TOKEN}@github.com/${GIT_USER_NAME}/Microservices-E-Commerce-eks-project.git HEAD:master
                            
                            echo "‚úÖ Changes pushed to Git"
                        """
                    }
                }
            }
        }
        
        stage('Learner Lab Budget Reminder') {
            steps {
                script {
                    echo """
                    üí∞ LEARNER LAB BUDGET REMINDER üí∞
                    ================================
                    Service: ${SERVICE_NAME}
                    ECR Repository: ${ECR_REPO_NAME}
                    Image: ${BUILD_NUMBER}
                    
                    ‚úÖ USING EXISTING ECR: ${ECR_REPO_NAME}
                    
                    COST NOTES:
                    - ECR storage: ~\\\$0.10 per GB-month
                    - Lifecycle policy: Keeps only 5 images
                    - Clean old images regularly
                    
                    NEXT STEPS:
                    1. Deploy to EKS: kubectl apply -f kubernetes-files/cartservice.yaml
                    2. Monitor: kubectl get pods -l app=cartservice
                    3. Cleanup: Stop services when not in use
                    ================================
                    """
                }
            }
        }
    }
    
    post {
        always {
            // Cleanup to save space
            sh '''
                echo "=== Cleaning up ==="
                docker system prune -f 2>/dev/null || true
                rm -f lifecycle-policy.json 2>/dev/null || true
            '''
        }
        
        success {
            echo """
            ‚úÖ Cart service pipeline completed successfully!
            ====================================
            Using existing ECR: ${ECR_REPO_NAME}
            Image: ${ECR_REPO_URL}:${BUILD_NUMBER}
            ====================================
            """
        }
        
        failure {
            echo """
            ‚ùå Cart service pipeline failed. Check logs above.
            
            Common issues:
            1. Dockerfile not found
            2. ECR repository ${ECR_REPO_NAME} doesn't exist
            3. AWS credentials not configured
            ====================================
            """
        }
        
        cleanup {
            cleanWs()
        }
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        retry(1)
    }
}