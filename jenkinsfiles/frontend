pipeline {
    agent any
    environment {
        GIT_REPO_NAME = "Microservices-E-Commerce-eks-project"
        GIT_EMAIL = "aymen.bendjaballah@univ-constantine2.dz"
        GIT_USER_NAME = "aymenmahrez-19"
        IMAGE_NAME = "frontend"
        REPO_URL = "851725560519.dkr.ecr.us-east-1.amazonaws.com/aymen-frontend"
        YAML_FILE = "frontend.yaml"
        AWS_REGION = "us-east-1"
    }
    options { timeout(time:30,unit:'MINUTES'); disableConcurrentBuilds(); buildDiscarder(logRotator(numToKeepStr:'10')) }
    stages {
        stage('Clean Workspace'){ steps { cleanWs() } }
        stage('Checkout'){ steps { git branch:'master', url:'https://github.com/aymenmahrez-19/Microservices-E-Commerce-eks-project.git' } }
        stage('Docker Build'){ steps { sh "docker build -t ${IMAGE_NAME} src/${IMAGE_NAME}" } }
        stage('Push to ECR'){ steps { sh """
            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${REPO_URL}
            docker tag ${IMAGE_NAME}:latest ${REPO_URL}:${BUILD_NUMBER}
            docker push ${REPO_URL}:${BUILD_NUMBER}
        """ } }
        stage('Update YAML & Git Push'){ steps {
            dir('kubernetes-files'){ withCredentials([usernamePassword(credentialsId:'my-git-pattoken', usernameVariable:'GIT_USER', passwordVariable:'GIT_TOKEN')]){
                sh """
                    git config user.email "${GIT_EMAIL}"
                    git config user.name "${GIT_USER_NAME}"
                    sed -i "s#image:.*#image: ${REPO_URL}:${BUILD_NUMBER}#g" ${YAML_FILE}
                    git add ${YAML_FILE}
                    git commit -m "Update ${IMAGE_NAME} image to version ${BUILD_NUMBER}" || echo "No changes"
                    git push https://${GIT_USER}:${GIT_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:master
                """
            } }
        } }
    }
    post { success{echo "✅ ${IMAGE_NAME} pushed"}; failure{echo "❌ ${IMAGE_NAME} failed"} }
}
