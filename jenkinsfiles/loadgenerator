pipeline {
    agent any

    environment {
        AWS_REGION = "us-east-1"
        AWS_ACCOUNT_ID = "851725560519"
        ECR_REPO = "851725560519.dkr.ecr.us-east-1.amazonaws.com/aymen-load-generator"
        IMAGE_NAME = "load-generator"
        YAML_FILE = "loadgenerator.yaml"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                dir('src/loadgenerator') {
                    sh 'docker build -t ${IMAGE_NAME}:latest .'
                }
            }
        }

        stage('Push to ECR') {
            steps {
                sh '''
                    aws ecr get-login-password --region $AWS_REGION | \
                    docker login --username AWS --password-stdin $ECR_REPO

                    docker tag ${IMAGE_NAME}:latest $ECR_REPO:latest
                    docker push $ECR_REPO:latest
                '''
            }
        }

        stage('Update YAML & Git Push') {
            steps {
                dir('kubernetes-files') {
                    withCredentials([string(credentialsId: 'my-git-pattoken', variable: 'GIT_TOKEN')]) {
                        sh '''
                            git config user.email "aymen.bendjaballah@univ-constantine2.dz"
                            git config user.name "aymenmahrez-19"

                            # Read current YAML
                            cat ${YAML_FILE}
                            
                            # Update image tag using BUILD_NUMBER
                            sed -i "s|image:.*|image: ${ECR_REPO}:${BUILD_NUMBER}|g" ${YAML_FILE}

                            git add ${YAML_FILE}
                            git commit -m "Update load-generator image to ${BUILD_NUMBER}" || echo "No changes"
                            git push https://${GIT_TOKEN}@github.com/aymenmahrez-19/Microservices-E-Commerce-eks-project.git HEAD:master
                        '''
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "✅ Load generator pipeline completed"
        }
        failure {
            echo "❌ Load generator pipeline failed"
        }
    }
}