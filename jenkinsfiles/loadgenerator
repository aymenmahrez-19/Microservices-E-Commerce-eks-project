pipeline {
    agent any

    environment {
        AWS_REGION = "us-east-1"
        ECR_REPO   = "851725560519.dkr.ecr.us-east-1.amazonaws.com/aymen-load-generator"
        IMAGE_NAME = "load-generator"
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                dir('src/loadgenerator') {
                    sh '''
                        docker build -t ${IMAGE_NAME}:latest .
                    '''
                }
            }
        }

        stage('Push to ECR') {
            steps {
                sh '''
                    aws ecr get-login-password --region ${AWS_REGION} \
                    | docker login --username AWS --password-stdin ${ECR_REPO}

                    docker tag ${IMAGE_NAME}:latest ${ECR_REPO}:latest
                    docker push ${ECR_REPO}:latest
                '''
            }
        }

stage('Update YAML & Git Push') {
    steps {
        dir('kubernetes-files') {
            withCredentials([string(credentialsId: 'my-git-pattoken', variable: 'GIT_TOKEN')]) {
                sh '''
                    git config user.email "aymen.bendjaballah@univ-constantine2.dz"
                    git config user.name "aymenmahrez-19"

                    YAML_FILE="loadgenerator.yaml"

                    if [ ! -f "$YAML_FILE" ]; then
                      echo "❌ $YAML_FILE not found"
                      exit 1
                    fi

                    sed -i "s#image:.*#image: 851725560519.dkr.ecr.us-east-1.amazonaws.com/aymen-load-generator:latest#g" $YAML_FILE

                    git add $YAML_FILE
                    git commit -m "Update load-generator image" || echo "No changes to commit"

                    git push https://${GIT_TOKEN}@github.com/aymenmahrez-19/Microservices-E-Commerce-eks-project.git HEAD:master
                '''
            }
        }
    }
}


    post {
        success {
            echo "✅ load-generator pipeline succeeded"
        }
        failure {
            echo "❌ load-generator pipeline failed"
        }
    }
}
