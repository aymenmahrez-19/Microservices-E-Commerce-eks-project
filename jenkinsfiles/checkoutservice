pipeline {
    agent any

    environment {
        AWS_REGION = 'us-east-1'
        AWS_ACCOUNT_ID = '851725560519'
        SERVICE_NAME = 'aymen-checkout-service'
        ECR_REPO = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${SERVICE_NAME}"
        IMAGE_TAG = "latest"
        YAML_FILE = "checkoutservice.yaml"
        GIT_REPO_NAME = "Microservices-E-Commerce-eks-project"
        GIT_USER_NAME = "aymenmahrez-19"
        GIT_EMAIL = "aymen.bendjaballah@univ-constantine2.dz"
    }

    stages {
        stage('Checkout') { steps { git branch: 'master', url: 'https://github.com/aymenmahrez-19/Microservices-E-Commerce-eks-project.git' } }
        stage('Login to ECR') { steps { sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REPO}" } }
        stage('Build Docker Image') { steps { dir('src/checkoutservice') { sh "docker build -t ${SERVICE_NAME}:${IMAGE_TAG} ." } } }
        stage('Tag & Push Docker Image') { steps { sh "docker tag ${SERVICE_NAME}:${IMAGE_TAG} ${ECR_REPO}:${IMAGE_TAG} && docker push ${ECR_REPO}:${IMAGE_TAG}" } }
        stage('Update Kubernetes YAML & Push') {
            steps { dir('kubernetes-files') { withCredentials([string(credentialsId: 'my-git-pattoken', variable: 'GIT_TOKEN')]) { sh """
                            git config user.email "${GIT_EMAIL}"
                            git config user.name "${GIT_USER_NAME}"
                            sed -i "s#image:.*#image: ${ECR_REPO}:${IMAGE_TAG}#g" ${YAML_FILE}
                            git add ${YAML_FILE}
                            git commit -m "Update ${SERVICE_NAME} image to ${IMAGE_TAG}" || echo "No changes to commit"
                            git push https://${GIT_USER_NAME}:${GIT_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:master
                        """ } } }
    }

    post { success { echo "✅ Docker image for ${SERVICE_NAME} pushed successfully!" } failure { echo "❌ Pipeline failed for ${SERVICE_NAME}" } }
}
